## Redis 数据过期删除策略

Redis 对 key 设置过期时间后，需要有相应的机制将已过期的键值对删除，而做这个工作的就是过期键值删除策略。

Redis的过期策略:惰性删除和定期删除相配合使用。

> 惰性删除

在设置该key过期时间后，我们不去管它，当需要该key时，我们在检查其是否过期，如果过期，我们就删掉它，反之返回该key。

* 优点 ：对CPU友好，只会在使用该key时才会进行过期检查，对于很多用不到的key不用浪费时间进行过期检查
* 缺点 ：对内存不友好，如果一个key已经过期，但是一直没有使用，那么该key就会一直存在内存中，内存永远不会释放

> 定期删除

redis中的一个定时任务（100ms）执行一次，扫描设置了过期时间的键并判断是否过期。

具体细节：

redis并不会一次性扫描所有的设置过期时间的键，因为这样会浪费大量的过cpu资源，它会每次扫描时限制扫扫秒时间和数量，以免性能过大对redis正常的使用产生影响。

默认的话，每次获取20个key判断是否过期，如果过期的key占比超过25%，则继续拉20个，如果小于25%则停止。还有一次删除时间不能超过25ms,如果发现占比超过25%，就要判断目前是否花费了25ms,如果到时间也会结束。

定期清理有两种模式：

* SLOW模式是定时任务，执行频率默认为10hz，每次不超过25ms，以通过修改配置文件redis.conf 的hz 选项来调整这个次数
* FAST模式执行频率不固定，但两次间隔不低于2ms，每次耗时不超过1ms。

优缺点：

* 优点：能有效释放过期键占用的内存，可以通过限制删除操作执行的时长和频率来减少删除操作对 CPU 的影响。
*  缺点：难以确定删除操作执行的时长和频率。如果执行的太频繁，就会对 CPU 不友好；如果执行的太少，那又和惰性删除一样了，过期 key 占用的内存不会及时得到释放。



可以看到上面两种各自的优点，所以Redis使用惰性删除和定期删除两种策略相互使用，以求在合理的使用cpu和避免使用内存浪费之前取平衡。